<div class="first-div">
  <button class="back-btn" (click)="goBack()">
    <i class="pi pi-arrow-left"></i>
  </button>
  <h3>Welcome To The {{mfDetails[0]?.scripname || "Mutual Fund Details"}}</h3>
</div>

<!-- Summary of Action -->
<div class="table-card">
  <div class="search-header p-d-flex p-ai-center p-jc-between">
    <h4>
      Summary Of Actions
      <button pButton type="button" label="IRR = {{ irrResult || 0 }}%" class="p-button-sm ml-2"
        style="height: 28px;"></button>
    </h4>
    <div class="search-container">
      <input pInputText type="text" (input)="onGlobalFilter($event, 'action')" placeholder="Search actions..." />
    </div>
  </div>

  <div class="card-row">
    <div class="card green-card">
      <h4>Total Available Units</h4>
      <p>Units: {{ availableUnits | number:'1.2-2' }}</p>
      <p>Amount: {{ availableAmount | currency:'INR' }}</p>
    </div>

    <div class="card blue-card">
      <h4>Total Units Sold</h4>
      <p>Units: {{ totalSalesUnits | number:'1.2-2' }}</p>
      <p>Amount: {{ totalSalesAmount | currency:'INR' }}</p>
    </div>

    <div class="card yellow-card">
      <h4>Total Value</h4>
      <p>{{ totalValue | currency:'INR' }}</p>
    </div>
  </div>

  <p-table #actionTableSummary [value]="actionTableList" dataKey="id" [paginator]="true" [rows]="10"
    [rowsPerPageOptions]="[5, 10, 25, 100, 500, 1000]"
    [globalFilterFields]="['sett_no','unit','order_number','purchase_amount','redeem_amount']" responsiveLayout="scroll"
    [resizableColumns]="true" columnResizeMode="expand" class="custom-table">

    <!-- Header -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="order_number">Order No <p-sortIcon field="order_number"></p-sortIcon></th>
        <th pSortableColumn="order_date">Order Date <p-sortIcon field="order_date"></p-sortIcon></th>
        <th pSortableColumn="nav">NAV <p-sortIcon field="nav"></p-sortIcon></th>
        <th pSortableColumn="unit">Units <p-sortIcon field="unit"></p-sortIcon></th>
        <th pSortableColumn="order_type">Action <p-sortIcon field="order_type"></p-sortIcon></th>
        <th pSortableColumn="purchase_amount">Amount <p-sortIcon field="purchase_amount"></p-sortIcon></th>
        <th pSortableColumn="net_amount">Net Amt <p-sortIcon field="purchase_amount"></p-sortIcon></th>
        <th pSortableColumn="redeem_amount">Redeem <p-sortIcon field="redeem_amount"></p-sortIcon></th>
        <th pSortableColumn="sett_no">Sett No <p-sortIcon field="sett_no"></p-sortIcon></th>
        <th pSortableColumn="sett_no">Action <p-sortIcon field="sett_no"></p-sortIcon></th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-entity>
      <tr>
        <td>{{ entity.order_number }}</td>
        <td>{{ entity.order_date }}</td>
        <td>{{ entity.nav | number:'1.2-2' }}</td>
        <td>{{ entity.unit | number:'1.2-2' }}</td>
        <td><p-tag [value]="entity.order_type" [severity]="getSeverity(entity.order_type)" /></td>
        <td>
          {{ entity.purchase_amount !== '-' ? (entity.purchase_amount | number:'1.2-2') : '-' }}
        </td>
        <td>{{ entity.net_amount | number:'1.2-2' }}</td>
        <td>
          {{ entity.redeem_amount !== '-' ? (entity.redeem_amount | number:'1.2-2') : '-' }}
        </td>
        <td>{{ entity.sett_no }}</td>
        <td>
          <p-speeddial [model]="getRowActions(entity)" direction="left" type="linear" showIcon="pi pi-plus"
            hideIcon="pi pi-times" [buttonStyle]="{'height':'25px','min-width':'27px','margin-right':'40px' }">
          </p-speeddial>
        </td>
      </tr>
    </ng-template>

    <!-- Footer (Summary Row) -->
    <ng-template pTemplate="footer">
      <tr class="summary-row">
        <td colspan="10" class="summary green">
          Total Available Units → Units: {{ availableUnits | number:'1.2-2' }} |
          Amount: {{ availableAmount | currency:'INR' }}
        </td>
      </tr>
      <tr class="summary-row">
        <td colspan="10" class="summary blue">
          Total Value → {{ totalValue | currency:'INR' }}
        </td>
      </tr>
      <tr class="summary-row">
        <td colspan="10" class="summary red">
          Total Units Sold → Units: {{ totalSalesUnits | number:'1.2-2' }} |
          Amount: {{ totalSalesAmount | currency:'INR' }}
        </td>
      </tr>

    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="5">No Records found</td>
      </tr>
    </ng-template>

  </p-table>
</div>

<!-- MCAP Tag Allocation -->
<div class="counts-card" style="margin-bottom: 2rem;">
  <p-card styleClass="P-card">
    <h4>MCAP Tag Allocation</h4>
    <div class="card-content">
      <div class="counts-section">
        <div>
          <h4>Total Number of Underlying : {{ actionCounts?.total_count }}</h4>
        </div>
        <div *ngFor="let tag of mcapTableList">
          <div class="count-item">
            <span class="dot" [ngStyle]="{'background-color': tag.color || '#42A5F5'}"></span>
            <span class="label">{{ tag.tag }}</span>
            <span class="percent">{{ tag.tag_percent | number:'1.0-1' }}%</span>
          </div>
        </div>
      </div>
      <div class="chart-section">
        <p-chart *ngIf="mcapChartData" type="pie" [data]="mcapChartData" [options]="mcapChartOptions"></p-chart>
      </div>
    </div>
  </p-card>
</div>

<!-- Summary of underlying -->
<div class="table-card">
  <h4>Summary Of Underlying</h4>
  <div class="search-header p-d-flex p-ai-center p-jc-between">
    <div class="underlying-date">
      Last Updated At
      <span class="date-badge">
        {{ underlyingTableList[0]?.created_at | date:'dd MMM yyyy' }}
      </span>
    </div>
    <div class="search-container">
      <input pInputText type="text" (input)="onGlobalFilter($event, 'underlying')" placeholder="Search underlying..." />
    </div>
  </div>

  <p-table #underlyingTable [value]="underlyingTableList" dataKey="id" [paginator]="true" [rows]="10"
    [rowsPerPageOptions]="[10, 25, 100, 500, 1000]"
    [globalFilterFields]="['scripcode','weightage','isin_code','company_name']" scrollHeight="400px"
    [responsiveLayout]="'scroll'" columnResizeMode="expand" class="custom-table">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="company_name">Company Name <p-sortIcon field="company_name"></p-sortIcon></th>
        <th pSortableColumn="scripcode">Scrip Code <p-sortIcon field="scripcode"></p-sortIcon></th>
        <th pSortableColumn="weightage">Weightage <p-sortIcon field="weightage"></p-sortIcon></th>
        <th pSortableColumn="sector">Sector <p-sortIcon field="sector"></p-sortIcon></th>
        <th pSortableColumn="tag">Tag <p-sortIcon field="tag"></p-sortIcon></th>
        <th pSortableColumn="isin_code">ISIN <p-sortIcon field="isin_code"></p-sortIcon></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-entity>
      <tr>
        <td>{{ entity.company_name }}</td>
        <td>{{ entity.scripcode }}</td>
        <td>{{ entity.weightage }} %</td>
        <td>{{ entity.sector }}</td>
        <td>{{ entity.tag }}</td>
        <td>{{ entity.isin_code }}</td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="6">No Records found</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Sector Allocation -->
<div class="counts-card" style="margin-bottom: 2rem;" *ngIf="underlyingTableList.length > 0">
  <p-card styleClass="P-card">
    <h4>Sector Allocation</h4>
    <div class="card-content">
      <div class="counts-section">
        <div>
          <h4>Total Number of Underlying : {{ sectorCounts?.total_count }}</h4>
        </div>
        <div *ngFor="let sector of sectorTableList">
          <div class="count-item">
            <span class="dot" [ngStyle]="{'background-color': sector.color || '#42A5F5'}"></span>
            <span class="label">{{ sector.sector }}</span>
            <span class="percent">{{ sector.sector_percent | number:'1.0-1' }}%</span>
          </div>
        </div>
      </div>
      <div class="chart-section">
        <p-chart *ngIf="sectorChartData" type="pie" [data]="sectorChartData" [options]="sectorChartOptions"></p-chart>
      </div>
    </div>
  </p-card>
</div>

<!-- edit action table row -->
<p-dialog header="Edit Action" [(visible)]="displayEditDialog" [modal]="true" [closable]="true"
  [style]="{ width: '40vw' }" [contentStyle]="{ 'overflow-y': 'auto' }">
  <form [formGroup]="mfActionTableForm" class="p-fluid">
    <div class="field" *ngFor="let field of currentActionTableFields">
      <label [for]="field.key">{{ field.label }}</label>

      <!-- Dropdown: Order Type -->
      <p-dropdown *ngIf="field.key === 'order_type'" [options]="orderTypeOptions" formControlName="order_type"
        placeholder="Select Order Type"></p-dropdown>

      <!-- Dropdown: Mode -->
      <p-dropdown *ngIf="field.key === 'mode'" [options]="modeOptions" formControlName="mode"
        placeholder="Select Mode"></p-dropdown>

      <!-- Calendar: order_date / trade_date / trans_date -->
      <p-datepicker *ngIf="field.key === 'order_date'" [formControlName]="field.key" placeholder="Select Date"
        showIcon="true" dateFormat="dd/mm/yy" appendTo="viewport" appendTo="body" [style]="{ width: '100%' }">
      </p-datepicker>

      <!-- Readonly Purchase Value -->

      <input *ngIf="field.key === 'net_total'" pInputText formControlName="net_total" readonly />

      <input *ngIf="field.key === 'entityid'" type="hidden" formControlName="entityid" />

      <!-- Default Input -->
      <input *ngIf="field.key !== 'order_type' && field.key !== 'mode'
               && field.key !== 'order_date'" [id]="field.key" pInputText [formControlName]="field.key"
        [placeholder]="'Enter ' + field.label" [readonly]="isReadOnlyField(field.key)"
        [ngClass]="{ 'readonly-field': isReadOnlyField(field.key) }" />

    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times"
      (click)="displayEditDialog=false"></p-button>
    <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check" (click)="saveEdit()"></p-button>
  </ng-template>
</p-dialog>

<div class="table-card" *ngIf="allNavs.length > 0">
  <h4>Summary Of NAV</h4>
  <div class="card">
    <p-chart type="line" [data]="data" [options]="options" class="h-[30rem]" />
  </div>
</div>


<p-confirmDialog></p-confirmDialog>