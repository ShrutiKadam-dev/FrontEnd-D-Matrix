<!-- Add Entity Button -->
<p-button label="Create Entity" icon="pi pi-plus" (click)="showModal()" styleClass="add-entity-btn"></p-button>

<!-- Search Box -->
<div class="search-container half-width">
  <span class="p-input-icon-left search-bar">
    <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Search..." />
  </span>
</div>

<!-- Add/Update Entity Dialog -->
<p-dialog [header]="isEditMode ? 'Edit Entity' : 'Add New Entity'" [(visible)]="displayModal" [modal]="true"
  [closable]="true" [style]="{ width: '35vw', 'max-height': '90vh' }" [contentStyle]="{ 'overflow-y': 'auto' }">
  <form [formGroup]="entityForm" class="p-fluid">
    <div class="field">
      <label for="scripname">Scrip Name</label>
      <input id="scripname" pInputText formControlName="scripname" placeholder="Enter Scrip Name" />
    </div>

    <div class="field">
      <label for="scripcode">Scrip Code</label>
      <input id="scripcode" pInputText formControlName="scripcode" placeholder="Enter Scrip Code" />
    </div>

    <div class="field">
      <label for="nickname">Nick Name</label>
      <input id="nickname" pInputText formControlName="nickname" placeholder="Enter Nickname" />
    </div>

    <div class="field">
      <label for="category">Category</label>
      <p-dropdown id="category" formControlName="category" [options]="categoryOptions" placeholder="Select Category"
        appendTo="body"></p-dropdown>
    </div>

    <div class="field">
      <label for="subcategory">Sub Category</label>
      <p-dropdown id="subcategory" formControlName="subcategory" [options]="subCategoryOptions"
        placeholder="Select Sub Category" appendTo="body" panelStyleClass="subcategory-panel"
        dropdownPosition="top"></p-dropdown>
    </div>

    <div class="field">
      <label for="benchmark">Benchmark</label>
      <input id="benchmark" pInputText formControlName="benchmark" placeholder="Enter Benchmark" />
    </div>

    <div class="field">
      <label for="isin">ISIN Code</label>
      <input id="isin" pInputText formControlName="isin" placeholder="Enter ISIN Code" />
    </div>

    <div class="dialog-actions">
      <p-button label="Cancel" icon="pi pi-times" styleClass="add-entity-btn" (click)="displayModal = false"></p-button>

      <p-button [label]="isEditMode ? 'Update' : 'Add'" icon="pi pi-check" styleClass="add-entity-btn"
        (click)="isEditMode ? saveUpdatedEntity() : addEntity()" [disabled]="entityForm.invalid"></p-button>
    </div>
  </form>
</p-dialog>

<!-- Entity Table -->
<p-table #dt [value]="entityList" dataKey="id" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,25,50]"
  [globalFilterFields]="['scripname', 'scripcode', 'nickname', 'category', 'subcategory', 'benchmark']"
  scrollHeight="700px">
  <ng-template pTemplate="header">
    <tr>
      <th>Scrip Name</th>
      <th>Scrip Code</th>
      <th>Benchmark</th>
      <th>Subcategory</th>
      <th>Action</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-entity>
    <tr>
      <td>{{ entity.scripname }}</td>
      <td>{{ entity.scripcode }}</td>
      <td>{{ entity.benchmark }}</td>
      <td>{{ entity.subcategory }}</td>
      <td>
        <p-button icon="pi pi-pencil" styleClass="custom-btn-edit" (click)="editEntity(entity)"></p-button>

        <p-button icon="pi pi-file-edit" styleClass="custom-btn-update" (click)="updateEntity(entity)"></p-button>

        <p-button icon="pi pi-trash" styleClass="custom-btn-delete" (click)="confirmDelete(entity)"></p-button>


      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Update Choice Dialog -->
<p-dialog header="Update Table" [(visible)]="displayUpdateChoiceModal" [modal]="true" [closable]="true"
  [style]="{ width: '30vw' }">
  <div class="p-fluid">
    <p>Which table would you like to update?</p>
    <div class="edit-choice-buttons">
      <p-button label="Contract Note" icon="pi pi-table" styleClass="add-entity-btn"
        (click)="updateActionTable(selectedEntity)"></p-button>
      <p-button *ngIf="!(selectedEntity?.category === 'Equity' && selectedEntity?.subcategory === 'Direct Equity')"
        label="Underlying" icon="pi pi-list" styleClass="add-entity-btn"
        (click)="updateUnderlyingTable(selectedEntity)"></p-button>
    </div>
  </div>
</p-dialog>

<!-- Add Underlying Table Dialog -->
<p-dialog header="Add Underlying Data" [(visible)]="displayUnderlyingModal" [modal]="true" [style]="{ width: '70vw' }"
  [closable]="true" class="underlying-modal">
  <form [formGroup]="underlyingForm">
    <table class="underlying-table">
      <thead>
        <tr>
          <th>Company Name</th>
          <th>Scrip Code</th>
          <th>Sector</th>
          <th>Weightage</th>
          <th>ISIN</th>
          <th style="width: 90px;">Action</th>
        </tr>
      </thead>
      <tbody formArrayName="rows">
        <tr *ngFor="let row of rows.controls; let i = index" [formGroupName]="i">
          <td>
            <p-autoComplete formControlName="company_name" [suggestions]="companySuggestions"
              (completeMethod)="searchCompany($event, i)" (onSelect)="onCompanySelect($event, i)"
              [field]="'name_of_company'" [forceSelection]="true" placeholder="Enter company name">
            </p-autoComplete>
          </td>
          <td>
            <input pInputText type="text" formControlName="scripcode" placeholder="Enter code" />
          </td>

          <td>
            <input pInputText type="text" formControlName="sector" placeholder="Enter sector" />
          </td>
          <td class="weightage-cell">
            <p-inputNumber formControlName="weightage" mode="decimal" [min]="0" [max]="100"
              placeholder="Enter weightage">
            </p-inputNumber>
          </td>


          <td>
            <input pInputText type="text" formControlName="isin_code" placeholder="Enter ISIN" readonly />
          </td>

          <td>
            <button type="button" class="remove-row-btn" *ngIf="rows.length > 1" (click)="removeRow(i)">
              Remove
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <button type="button" class="add-row-btn" (click)="addRow()">+ Add Row</button>

    <div class="modal-actions">
      <p-button label="Cancel" styleClass="add-entity-btn" (click)="displayUnderlyingModal = false"></p-button>
      <p-button label="Save" styleClass="add-entity-btn" (click)="submitUnderlyingData()"></p-button>
    </div>
  </form>
</p-dialog>

<!-- Add Action Table Dialog -->
<p-dialog header="Add Action Table Data" [(visible)]="displayActionTableModal" [modal]="true" [closable]="true"
  [style]="{ width: '40vw' }" [contentStyle]="{ 'overflow-y': 'auto' }">

  <!-- Normal Action Table -->
  <form *ngIf="!(selectedEntity?.category === 'Equity' && selectedEntity?.subcategory === 'Direct Equity')"
    [formGroup]="actionTableForm" class="p-fluid">

    <div class="field" *ngFor="let field of actionTableFields">
      <label [for]="field.key">{{ field.label }}</label>

      <!-- Dropdown: Order Type -->
      <p-dropdown *ngIf="field.key === 'order_type'" [options]="orderTypeOptions" formControlName="order_type"
        placeholder="Select Order Type"></p-dropdown>

      <!-- Dropdown: Mode -->
      <p-dropdown *ngIf="field.key === 'mode'" [options]="modeOptions" formControlName="mode"
        placeholder="Select Mode"></p-dropdown>

      <!-- Calendar: Order Date -->
      <p-datepicker *ngIf="field.key === 'order_date'" formControlName="order_date" placeholder="Select Date"
        showIcon="true" dateFormat="dd/mm/yy" appendTo="viewport" appendTo="body"   [style]="{ width: '100%' }">
      </p-datepicker>


      <!-- Readonly Purchase Value -->
      <input *ngIf="field.key === 'purchase_value'" pInputText formControlName="purchase_value" readonly />

      <!-- Default Input -->
      <input
        *ngIf="field.key !== 'order_type' && field.key !== 'mode' && field.key !== 'purchase_value' && field.key !== 'order_date'"
        [id]="field.key" pInputText [formControlName]="field.key" [placeholder]="'Enter ' + field.label"
        [readonly]="isReadOnlyField(field.key)" [ngClass]="{ 'readonly-field': isReadOnlyField(field.key) }" />
    </div>

    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times"
        (click)="displayActionTableModal = false"></p-button>
      <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check" [disabled]="actionTableForm.invalid"
        (click)="saveActionTableData()"></p-button>
    </div>
  </form>

  <!-- Direct Equity Action Table -->
  <form *ngIf="selectedEntity?.category === 'Equity' && selectedEntity?.subcategory === 'Direct Equity'"
    [formGroup]="directEquityActionTableForm" class="p-fluid">

    <div class="field" *ngFor="let field of directEquityActionTableFields">
      <label [for]="field.key">{{ field.label }}</label>

      <!-- Dropdown: Order Type -->
      <p-dropdown *ngIf="field.key === 'order_type'" [options]="orderTypeOptions" formControlName="order_type"
        placeholder="Select Order Type"></p-dropdown>

      <p-datepicker *ngIf="field.key === 'trade_date'" formControlName="trade_date" placeholder="Select Date"
        showIcon="true" dateFormat="dd/mm/yy" appendTo="viewport" appendTo="body"   [style]="{ width: '100%' }">
      </p-datepicker>


      <input *ngIf="field.key !== 'order_type' && field.key !== 'trade_date'" [id]="field.key" pInputText
        [formControlName]="field.key" [placeholder]="'Enter ' + field.label" />

    </div>

    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times"
        (click)="displayActionTableModal = false"></p-button>
      <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check"
        [disabled]="directEquityActionTableForm.invalid" (click)="saveDirectEquityActionTableData()"></p-button>
    </div>
  </form>


</p-dialog>


<p-confirmDialog></p-confirmDialog>