<!-- Loader -->
<div *ngIf="loading" class="loader-container">
  <p-progressSpinner></p-progressSpinner>
  <p style="margin-top: 12px;">Loading entities...</p>
</div>

<!-- Empty State -->
<div *ngIf="!loading && entityList?.length === 0" class="empty-container">
  <p>No records found</p>
</div>

<div class="table-card" *ngIf="!loading && (entityList?.length ?? 0) > 0">
  <!-- Header Section -->
  <div class="entity-header p-d-flex p-ai-center p-jc-between">

    <!-- Left Section (Buttons) -->
    <div class="button-group p-d-flex p-ai-center">
      <p-button label="Create Entity" icon="pi pi-plus" (click)="showModal()" styleClass="add-entity-btn"></p-button>
      <p-button label="Upload PDF" icon="pi pi-file-pdf" (click)="showAutoModal()"
        styleClass="add-entity-btn ml-4"></p-button>
    </div>

    <!-- Right Section (Search Bar) -->
    <form [formGroup]="searchForm" class="search-container">
      <input pInputText type="text" formControlName="searchText" placeholder="Search entities..." />

      <button *ngIf="searchForm.get('searchText')?.value" pButton icon="pi pi-times" class="p-button-text" type="button"
        (click)="clearSearch()">
      </button>
    </form>

  </div>

  <!-- Entity Table -->
  <!-- [scrollable]="true" [virtualScroll]="true"  scrollHeight="538x" -->
  <div class="entity-table-wrapper">
    <p-table #dt [value]="entityList" dataKey="id" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,25,50]"
      [paginatorDropdownAppendTo]="'body'"
      [globalFilterFields]="['scripname', 'scripcode', 'nickname', 'category', 'subcategory', 'benchmark']">
      <ng-template pTemplate="header">
        <tr>
          <th>Scrip Name</th>
          <th>Scrip Code</th>
          <th>Benchmark</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-entity>
        <tr>
          <td [title]="entity.scripname">{{ entity.scripname }}</td>
          <td>{{ entity.scripcode }}</td>
          <td>{{ entity.created_at }}</td>
          <td>{{ entity.category }}</td>
          <td>{{ entity.subcategory }}</td>
          <td>
            <p-button icon="pi pi-pencil" styleClass="custom-btn-edit" (click)="editEntity(entity)"></p-button>
            <p-button icon="pi pi-file-edit" styleClass="custom-btn-update" (click)="updateEntity(entity)"></p-button>
            <p-button icon="pi pi-trash" styleClass="custom-btn-delete" (click)="confirmDelete(entity)"></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="5">No Records found</td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>

<!-- Add/Update Entity Dialog -->
<p-dialog [header]="isEditMode ? 'Edit Entity' : 'Add New Entity'" [(visible)]="displayModal" [modal]="true"
  [closable]="true" [style]="{ width: '50vw', 'max-height': '100vh' }" [contentStyle]="{ 'overflow-y': 'auto' }">

  <form [formGroup]="entityForm">

    <!-- 1st line: Category + Subcategory (50% + 50%) -->
    <div class="grid mb-3">
      <div class="col-12 md:col-6">
        <label for="category">Category</label>
        <p-dropdown id="category" formControlName="category" [options]="categoryOptions" placeholder="Select Category"
          appendTo="body"></p-dropdown>
      </div>
      <div class="col-12 md:col-6">
        <label for="subcategory">Sub Category</label>
        <p-dropdown id="subcategory" formControlName="subcategory" [options]="subCategoryOptions"
          placeholder="Select Sub Category" appendTo="body"></p-dropdown>
      </div>
    </div>

    <!-- 2nd line: ISIN (100%) -->
    <div class="grid mb-3">
      <div class="col-12">
        <label for="isin">ISIN Code</label>
        <input id="isin" pInputText formControlName="isin" placeholder="Enter ISIN Code" />
      </div>
    </div>

    <!-- 3rd line: Name + Code + Nickname (33% each) -->
    <div class="grid mb-3">
      <div class="col-12 md:col-4">
        <label for="scripname">Scrip Name</label>
        <input id="scripname" pInputText formControlName="scripname" placeholder="Enter Scrip Name" />
      </div>
      <div class="col-12 md:col-4">
        <label for="scripcode">Scrip Code</label>
        <input id="scripcode" pInputText formControlName="scripcode" placeholder="Enter Scrip Code" />
      </div>
      <div class="col-12 md:col-4">
        <label for="nickname">Nick Name</label>
        <input id="nickname" pInputText formControlName="nickname" placeholder="Enter Nickname" />
      </div>
    </div>

    <!-- 4th line: Benchmark (100%) -->
    <div class="grid mb-3">
      <div class="col-12">
        <label for="benchmark">Benchmark</label>
        <input id="benchmark" pInputText formControlName="benchmark" placeholder="Enter Benchmark" />
      </div>
    </div>

    <!-- 5th line: AIF Category + AIF Class (50% + 50%) -->
    <div class="grid mb-3" *ngIf="entityForm.get('aifCategory')?.enabled || entityForm.get('aifClass')?.enabled">
      <div class="col-12 md:col-6" *ngIf="entityForm.get('aifCategory')?.enabled">
        <label for="aifCategory">AIF Category</label>
        <p-dropdown id="aifCategory" formControlName="aifCategory" [options]="subAIFCategoryOptions"
          placeholder="Select AIF Category" appendTo="body"></p-dropdown>
      </div>
      <div class="col-12 md:col-6" *ngIf="entityForm.get('aifClass')?.enabled">
        <label for="aifClass">AIF Class</label>
        <input id="aifClass" pInputText formControlName="aifClass" placeholder="Enter AIF Class" />
      </div>
    </div>

    <!-- Footer -->
    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" icon="pi pi-times" styleClass="add-entity-btn" (click)="displayModal = false"></p-button>
      <p-button [label]="isEditMode ? 'Update' : 'Add'" icon="pi pi-check" styleClass="add-entity-btn"
        (click)="isEditMode ? saveUpdatedEntity() : addEntity()" [disabled]="entityForm.invalid"></p-button>
    </div>
  </form>
</p-dialog>

<!-- Update Choice Dialog -->
<p-dialog header="Update Table" [(visible)]="displayUpdateChoiceModal" [modal]="true" [closable]="true"
  [style]="{ width: '36vw'}">
  <div class="p-fluid">
    <p>Which table would you like to update?</p>
    <div class="edit-choice-buttons">

      <!-- Contract Note (always available) -->
      <p-button
        *ngIf="!(selectedEntity?.subcategory === 'PMS' && (selectedEntity?.category === 'Equity' || selectedEntity?.category === 'Fixed_Income' || selectedEntity?.category === 'Commodities'))"
        label="Contract Note" icon="pi pi-table" styleClass="add-entity-btn"
        (click)="updateActionTable(selectedEntity)"></p-button>

      <!-- Underlying (hide for Direct Equity & ETF) -->
      <p-button *ngIf="!(((selectedEntity?.category === 'Equity' || selectedEntity?.category === 'Fixed_Income' || selectedEntity?.category === 'Commodities') 
          && (selectedEntity?.subcategory === 'Direct Equity' || selectedEntity?.subcategory === 'ETF')))"
        label="Underlying" icon="pi pi-list" styleClass="add-entity-btn"
        (click)="updateUnderlyingTable(selectedEntity)"></p-button>

      <!-- NAV Update (only for AIF) -->
      <p-button
        *ngIf="(( (selectedEntity?.category === 'Equity' || selectedEntity?.category === 'Fixed_Income' || selectedEntity?.category === 'Commodities') 
      && selectedEntity?.subcategory === 'Alternative Investment Funds')|| ( selectedEntity?.category === 'Equity' && selectedEntity?.subcategory === 'Mutual Fund'))"
        label="NAV Update" icon="pi pi-dollar" styleClass="add-entity-btn"
        (click)="openNavModal(selectedEntity)"></p-button>


      <ng-container
        *ngIf="(selectedEntity?.subcategory === 'PMS' && (selectedEntity?.category === 'Equity' || selectedEntity?.category === 'Fixed_Income' || selectedEntity?.category === 'Commodities'))">

        <p-button label="Client Action" icon="pi pi-user" styleClass="add-entity-btn"
          (click)="openPmsClientAction(selectedEntity)">
        </p-button>

        <p-button label="AMC Action" icon="pi pi-building" styleClass="add-entity-btn"
          (click)="openPmsAmcAction(selectedEntity)">
        </p-button>

      </ng-container>

    </div>
  </div>
</p-dialog>

<!-- Add Underlying Table Dialog -->
<p-dialog header="Add Underlying Data" [(visible)]="displayUnderlyingModal" [modal]="true" [style]="{ width: '70vw' }"
  [closable]="true" class="underlying-modal">
  <form [formGroup]="underlyingForm">
    <table class="underlying-table">
      <thead>
        <tr>
          <th>Company Name</th>
          <th>Scrip</th>
          <th>Weightage</th>
          <th>Sector</th>
          <th>MCAP</th>
          <th>ISIN</th>
          <th style="width: 90px;">Action</th>
        </tr>
      </thead>
    </table>
    <div class="underlying-table-container">
      <table class="underlying-table">

        <tbody formArrayName="rows">
          <tr *ngIf="rows.length === 0">
            <td colspan="7" style="text-align: center; padding: 1rem; color: #777;">
              No records found
            </td>
          </tr>
          <tr *ngFor="let row of rows.controls; let i = index" [formGroupName]="i">
            <td>
              <p-autoComplete formControlName="company_name" [suggestions]="companySuggestions"
                (completeMethod)="searchCompany($event, i)" (onSelect)="onCompanySelect($event, i)"
                [field]="'company_name'" [forceSelection]="true" placeholder="Enter company name" appendTo="viewport"
                appendTo="body">
              </p-autoComplete>
            </td>
            <td>
              <input pInputText type="text" formControlName="scripcode" placeholder="Enter Scrip"
                [readonly]="row.get('fromApi')?.value" />
            </td>
            <td class="weightage-cell">
              <p-inputNumber formControlName="weightage" mode="decimal" [min]="0" [max]="100" [minFractionDigits]="0"
                [maxFractionDigits]="3" [step]="0.001" placeholder="Enter weightage"
                [readonly]="row.get('fromApi')?.value">
              </p-inputNumber>
            </td>
            <td>
              <input pInputText type="text" formControlName="sector" placeholder="Enter Sector"
                [readonly]="row.get('fromApi')?.value" />
            </td>

            <td>
              <input pInputText type="text" formControlName="tag" placeholder="Enter MCAP"
                [readonly]="row.get('fromApi')?.value" />
            </td>
            <td>
              <input pInputText type="text" formControlName="isin_code" placeholder="Enter ISIN"
                [readonly]="row.get('fromApi')?.value" />
            </td>

            <td>
              <button type="button" class="remove-row-btn" *ngIf="rows.length >= 1" (click)="removeRow(i)">
                Remove
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-actions">
      <div class="left-actions">
        <button type="button" class="add-row-btn" (click)="addRow()">+ Add Row</button>
      </div>
      <div class="right-actions">
        <p-button label="Cancel" styleClass="add-entity-btn" (click)="displayUnderlyingModal = false"></p-button>
        <p-button label="Save" styleClass="add-entity-btn" (click)="submitUnderlyingData()"></p-button>
      </div>
    </div>

  </form>
</p-dialog>

<!-- Simple Uploading underlying properties Loading Modal -->
<p-dialog header="Please Wait" [(visible)]="isSubmitting" [modal]="true" [closable]="false"
  [style]="{ width: '350px' }">
  <div style="text-align:center; padding:20px;">
    <p-progressSpinner styleClass="w-4 h-4"></p-progressSpinner>
    <p style="margin-top: 15px;">Uploading underlying properties...</p>
  </div>
</p-dialog>

<!-- Simple Uploading underlying properties Loading Modal -->
<p-dialog header="Please Wait" [(visible)]="pdfIsSubmitting" [modal]="true" [closable]="false"
  [style]="{ width: '350px' }">
  <div style="text-align:center; padding:20px;">
    <p-progressSpinner styleClass="w-4 h-4"></p-progressSpinner>
    <p style="margin-top: 15px;">Uploading Pdf...</p>
  </div>
</p-dialog>

<!-- Add Action Table Dialog -->
<p-dialog header="Add Action Table Data" [(visible)]="displayActionTableModal" [modal]="true" [closable]="true"
  [style]="{ width: '40vw' }" [contentStyle]="{ 'overflow-y': 'auto' }">

  <form [formGroup]="currentActionTableForm" class="p-fluid">

    <div class="field" *ngFor="let field of currentActionTableFields">
      <label [for]="field.key">{{ field.label }}</label>

      <!-- Dropdown: Order Type -->
      <p-dropdown *ngIf="field.key === 'order_type'" [options]="orderTypeOptions" formControlName="order_type"
        placeholder="Select Order Type"></p-dropdown>

      <p-dropdown *ngIf="field.key === 'pms_order_type' || field.key === 'trans_type'" [options]="PmsOrderTypeOptions"
       [formControlName]="field.key" placeholder="Select Type"></p-dropdown>

      <!-- Dropdown: Mode -->
      <p-dropdown *ngIf="field.key === 'mode'" [options]="modeOptions" formControlName="mode"
        placeholder="Select Mode"></p-dropdown>

      <!-- Calendar: order_date / trade_date / trans_date -->
      <p-datepicker *ngIf="field.key === 'order_date' || field.key === 'trade_date' || field.key === 'trans_date'"
        [formControlName]="field.key" placeholder="Select Date" showIcon="true" dateFormat="dd/mm/yy"
        appendTo="viewport" appendTo="body" [style]="{ width: '100%' }">
      </p-datepicker>

      <!-- InputMask: order_time -->
      <p-inputMask *ngIf="field.key === 'order_time' || field.key === 'trade_time'" mask="99:99:99"
        [formControlName]="field.key" placeholder="HH:mm:ss" [style]="{ width: '100%' }">
      </p-inputMask>

      <!-- Readonly Purchase Value -->
      <input *ngIf="field.key === 'purchase_value'" pInputText formControlName="purchase_value" readonly />

      <input *ngIf="field.key === 'net_total'" pInputText formControlName="net_total" readonly />

      <input *ngIf="field.key === 'entityid'" type="hidden" formControlName="entityid" />

      <!-- Default Input -->
      <input *ngIf="field.key !== 'order_type' && field.key !== 'mode'
               && field.key !== 'purchase_value'
               && field.key !== 'order_date'
               && field.key !== 'trade_date'
               && field.key !== 'trans_type'
               && field.key !== 'trans_date'
              && field.key !== 'net_total'
               && field.key !== 'order_time'
               && field.key !== 'pms_order_type'
               && field.key !== 'trade_time'" [id]="field.key" pInputText [formControlName]="field.key"
        [placeholder]="'Enter ' + field.label" [readonly]="isReadOnlyField(field.key)"
        [ngClass]="{ 'readonly-field': isReadOnlyField(field.key) }" />

    </div>

    <!-- Price of pms field -->
    <div class="field"
      *ngIf="currentActionTableForm.get('pms_order_type')?.value || currentActionTableForm.get('trans_type')?.value">
      <label>
        {{
        (currentActionTableForm.get('pms_order_type')?.value || currentActionTableForm.get('trans_type')?.value) ===
        'Subscription'
        ? 'Subscription Amount'
        : 'Redemption Amount'
        }}
      </label>
      <input pInputText formControlName="price" [placeholder]="'Enter ' + ((currentActionTableForm.get('pms_order_type')?.value || currentActionTableForm.get('trans_type')?.value) === 'Subscription'
      ? 'Subscription Amount'
      : 'Redemption Amount')" />
    </div>

    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times"
        (click)="displayActionTableModal = false"></p-button>
      <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check" [disabled]="currentActionTableForm.invalid"
        (click)="saveCurrentActionTableData()"></p-button>
    </div>
  </form>
</p-dialog>

<!-- NAV Modal -->
<p-dialog header="Add NAV" [(visible)]="displayNavModal" [modal]="true" [closable]="true" [style]="{ width: '30vw' }">
  <form [formGroup]="selectedEntity?.subcategory === 'Alternative Investment Funds' ? navFormAIF : navFormMF">

    <!-- AIF fields -->
    <div *ngIf="selectedEntity?.subcategory === 'Alternative Investment Funds'">
      <div class="field">
        <label for="pre_tax_nav">Pre-Tax NAV</label>
        <input id="pre_tax_nav" pInputText formControlName="pre_tax_nav" placeholder="Enter Pre-Tax NAV" />
      </div>
      <div class="field">
        <label for="post_tax_nav">Post-Tax NAV</label>
        <input id="post_tax_nav" pInputText formControlName="post_tax_nav" placeholder="Enter Post-Tax NAV" />
      </div>
      <div class="field">
        <label for="nav_date">Date</label>
        <p-datepicker id="nav_date" formControlName="nav_date" showIcon="true" dateFormat="dd/mm/yy" appendTo="body"
          [style]="{ width: '100%' }"></p-datepicker>
      </div>
    </div>

    <!-- MF fields -->
    <div *ngIf="selectedEntity?.subcategory === 'Mutual Fund'">
      <div class="field">
        <label for="nav_date">NAV Date</label>
        <p-datepicker id="nav_date" formControlName="nav_date" showIcon="true" dateFormat="dd/mm/yy" appendTo="body"
          [style]="{ width: '100%' }"></p-datepicker>
      </div>
      <div class="field">
        <label for="nav">Nav</label>
        <input id="nav" pInputText formControlName="nav" placeholder="Enter NAV" />
      </div>
    </div>

    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times"
        (click)="displayNavModal = false"></p-button>
      <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check"
        [disabled]="(selectedEntity?.subcategory === 'Alternative Investment Funds' ? navFormAIF : navFormMF).invalid"
        (click)="saveNavData()"></p-button>

    </div>
  </form>
</p-dialog>

<!-- PDF Auto Modal -->
<p-dialog header="Automation" [(visible)]="displayAutoModal" [modal]="true" [closable]="true"
  [style]="{ width: '30vw' }">
  <form [formGroup]="automationForm" class="p-fluid">

    <div class="field">
      <label for="category">Category</label>
      <p-dropdown id="category" formControlName="category" [options]="categoryOptions" placeholder="Select Category"
        appendTo="body">
      </p-dropdown>
    </div>

    <div class="field">
      <label for="subcategory">Sub Category</label>
      <p-dropdown id="subcategory" formControlName="subcategory" [options]="automationSubCategoryOptions"
        placeholder="Select Sub Category" appendTo="body" panelStyleClass="subcategory-panel" dropdownPosition="top">
      </p-dropdown>
    </div>

    <div class="field">
      <!-- wire file upload to a handler that will update automationForm control -->
      <p-fileupload name="demo[]" (onSelect)="onFileSelect($event)" (onRemove)="onFileRemove($event)" [multiple]="false"
        accept=".pdf" maxFileSize="1000000" mode="advanced">
        <ng-template #empty>
          <div>Drag and drop files to here to upload.</div>
        </ng-template>
      </p-fileupload>
    </div>

    <div class="dialog-actions flex justify-content-end gap-2 mt-3">
      <p-button label="Cancel" styleClass="add-entity-btn" icon="pi pi-times" (click)="displayAutoModal = false">
        <!-- <-- close correct modal -->
      </p-button>

      <p-button label="Save" styleClass="add-entity-btn" icon="pi pi-check" [disabled]="automationForm.invalid"
        (click)="saveAutomationData()">
      </p-button>
    </div>
  </form>
</p-dialog>

<p-confirmDialog></p-confirmDialog>

<p-toast></p-toast>